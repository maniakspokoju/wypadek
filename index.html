<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini gra QR – 9.9.0</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
h1 { font-size:26px; text-align:center; margin:20px 0; }

button { width:100%; padding:18px; font-size:22px; margin:20px 0; border-radius:12px; border:none; background:#007bff; color:white; }
button:active { background:#0056b3; }

#screen-game { display:none; text-align:center; }
#targetLetter { font-size:140px; font-weight:bold; margin:0; line-height:1.2; }
#timerInfo { font-size:72px; margin:10px 0; }
#pointsClock { display:flex; justify-content:space-between; font-size:28px; padding:0 20px; }

#overlayMessage {
  position: fixed; 
  bottom: 20px; 
  width:100%; 
  text-align:center; 
  font-size:48px; 
  font-weight:bold; 
  color:white;
}

.locked { background-color:#cc0000 !important; color:white !important; }
.flash-success { background-color:#00cc44 !important; color:black !important; }
.flash-error { background-color:#ff4444 !important; color:black !important; }

#screen-end { display:none; padding:20px; text-align:center; font-size:28px; }
#endMessage { font-size:48px; font-weight:bold; color:white; background-color:green; padding:20px; margin:20px 0; }
#endRoute { margin-top:20px; font-size:28px; }
</style>
</head>
<body>

<h1>Mini gra QR – 9.9.0</h1>

<div id="screen-init">
  <label>
    Wybierz numer trasy (5-15):
    <input type="number" id="inputRoute" min="5" max="15" value="5">
  </label>
  <br><br>
  <label>
    Czas na zeskanowanie kolejnej litery (3-60 s):
    <input type="number" id="inputTime" min="3" max="60" value="10">
  </label>
  <br><br>
  <button id="startBtn">START</button>
</div>

<div id="screen-game">
<p id="targetLetter"></p>
<p id="timerInfo"></p>
<div id="pointsClock">
  <div>Punkty: <span id="points">0</span></div>
  <div>Czas gry: <span id="gameClock">00:00</span></div>
</div>
<p id="overlayMessage"></p>
</div>

<div id="screen-end">
  <div id="endMessage"></div>
  <div id="endRoute"></div>
</div>

<script>
// ===== STAŁE TRASY =====
const ROUTES = {
  5: ["A","C","B","E","G"],
  6: ["D","A","F","C","B","E"],
  7: ["B","G","C","A","E","D","F"],
  8: ["F","A","C","B","G","E","D","A"],
  9: ["C","B","F","E","A","G","D","C","B"],
  10:["A","D","F","B","C","G","E","B","A","D"],
  11:["G","C","B","E","A","F","D","G","C","B","E"],
  12:["B","E","G","C","A","F","D","B","G","C","E","A"],
  13:["D","B","F","C","A","G","E","B","C","D","F","A","G"],
  14:["A","C","E","B","D","F","G","C","A","B","E","D","F","G"],
  15:["B","D","A","G","C","F","E","B","C","D","A","F","G","E","C"]
};

// ===== ZMIENNE =====
let route = [];
let routeIndex = 0;
let currentTarget = null;
let history = [];
let points = 0;
let isLocked = false;
let timeLeft = 5;
let timerInterval = null;
let gameStartTime = null;
let gameClockInterval = null;
let gameFinished = false;
let scanTime = 10;

const startBtn = document.getElementById("startBtn");
const targetLetter = document.getElementById("targetLetter");
const timerInfo = document.getElementById("timerInfo");
const pointsEl = document.getElementById("points");
const gameClockEl = document.getElementById("gameClock");
const overlay = document.getElementById("overlayMessage");
const screenInit = document.getElementById("screen-init");
const screenGame = document.getElementById("screen-game");
const screenEnd = document.getElementById("screen-end");
const endMessage = document.getElementById("endMessage");
const endRoute = document.getElementById("endRoute");

// ===== FUNKCJE =====
function initializeRoute() {
  routeIndex = 0;
  currentTarget = route[routeIndex];
  history = [currentTarget];
  updateDisplay();
}

function moveToNextTarget() {
  routeIndex++;
  currentTarget = route[routeIndex];
  history.push(currentTarget);
  updateDisplay();
}

function updateDisplay() {
  targetLetter.innerText = currentTarget;
  timerInfo.innerText = `Czas: ${timeLeft}s`;
  pointsEl.innerText = points;
}

function startTimer() {
  clearInterval(timerInterval);
  timeLeft = scanTime;
  timerInfo.innerText = `Czas: ${timeLeft}s`;

  timerInterval = setInterval(() => {
    timeLeft--;
    timerInfo.innerText = `Czas: ${timeLeft}s`;
    if(timeLeft <=0) {
      clearInterval(timerInterval);
      lockGame();
    }
  },1000);
}

function lockGame() {
  isLocked = true;
  document.body.classList.add("locked");
  overlay.style.display="flex";
  overlay.innerText="BLOKADA";
  if(navigator.vibrate) navigator.vibrate([200,100,200,100,400]);
}

function unlockGame() {
  if(!isLocked) return;
  isLocked=false;
  document.body.classList.remove("locked");
  overlay.style.display="none";
  startTimer();
}

function flashScreen(type,message) {
  overlay.style.display="flex";
  overlay.innerText=message;
  if(type==="success") document.body.classList.add("flash-success");
  if(type==="error") document.body.classList.add("flash-error");
  setTimeout(()=> {
    document.body.classList.remove("flash-success");
    document.body.classList.remove("flash-error");
    if(!isLocked) overlay.style.display="none";
  },1000);
}

function onScan(text) {
  if(gameFinished) return;
  const code = text.toUpperCase().trim();
  if(isLocked) { if(code==="UNLOCK") unlockGame(); return; }

  if(code===currentTarget) {
    clearInterval(timerInterval);
    points++;
    history.push(currentTarget);
    updateDisplay();
    flashScreen("success","SUKCES");

    if(routeIndex >= route.length-1) {
      gameFinished=true;
      clearInterval(timerInterval);
      clearInterval(gameClockInterval);
      setTimeout(()=> {
        screenGame.style.display="none";
        screenEnd.style.display="block";
        endMessage.innerText=`WYGRANA!\nCzas: ${gameClockEl.innerText}`;
        endRoute.innerText="Trasa: "+history.join(" → ");
      },800);
      return;
    }

    setTimeout(()=> {
      moveToNextTarget();
      startTimer();
    },1000);

  } else {
    flashScreen("error","BŁĘDNY KOD");
  }
}

function startGameClock() {
  gameStartTime=Date.now();
  gameClockInterval = setInterval(()=>{
    const elapsed = Date.now()-gameStartTime;
    const minutes=Math.floor(elapsed/60000);
    const seconds=Math.floor((elapsed/1000)%60);
    gameClockEl.innerText=`${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  },200);
}

// ===== START =====
startBtn.onclick = async () => {
  // Pobranie wartości pola czasu
  const timeInput = parseInt(document.getElementById("inputTime").value);
  if(timeInput>=3 && timeInput<=60) scanTime = timeInput;

  // Wybrana trasa
  const routeNumber = parseInt(document.getElementById("inputRoute").value);
  if(routeNumber>=5 && routeNumber<=15) route = ROUTES[routeNumber];
  else route = ROUTES[5]; // domyślnie 5

  // Ukrycie startu i pokazanie gry
  screenInit.style.display="none";
  screenGame.style.display="block";

  startGameClock();
  initializeRoute();
  startTimer();

  // NFC
  if('NDEFReader' in window){
    try{
      const nfcReader = new NDEFReader();
      await nfcReader.scan();
      nfcReader.onreading = event => {
        const decoder = new TextDecoder();
        const record = event.message.records[0];
        let text = decoder.decode(record.data);
        text = text.replace(/\u0000/g,"").trim();
        onScan(text);
      };
    } catch(e){ console.log("Błąd NFC:",e); }
  }
};
</script>
</body>
</html>
