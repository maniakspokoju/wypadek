<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mini gra QR â€“ trasa staÅ‚a</title>
<style>
 body {
   font-family: Arial, sans-serif;
   padding: 16px;
   margin: 0;
   font-size: 20px;
   background: #f4f4f4;
 }

 h1 {
   font-size: 26px;
   margin-bottom: 20px;
 }

 button {
   width: 100%;
   padding: 18px;
   font-size: 22px;
   margin: 10px 0;
   border-radius: 12px;
   border: none;
   background: #007bff;
   color: white;
 }

 button:active {
   background: #0056b3;
 }

 .info {
   margin-top: 12px;
   font-weight: bold;
   font-size: 22px;
 }

 .big { font-size: 28px; }
 .green { color: green; }
 .red { color: red; }

 #overlayMessage {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   display: none;
   justify-content: center;
   align-items: center;
   font-size: 48px;
   font-weight: bold;
   z-index: 999;
 }

 /* EFEKTY */
 .flash-success { background-color: #00cc44 !important; color: black !important; }
 .flash-error { background-color: #ff4444 !important; color: black !important; }
 .locked { background-color: #cc0000 !important; color: black !important; }

 #scanResult { display:none; }
</style>
</head>
<body>
<h1>Mini gra QR â€“ trasa staÅ‚a 9.6.8</h1>

<div id="screen-init">
  <p>ZeskanowaÅ‚eÅ› kod startowy.</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <p class="info big" id="targetInfo"></p>
  <p class="info" id="status"></p>
  <p class="info" id="timerInfo"></p>
  <p class="info" id="historyInfo">Historia:</p>
  <div style="display:flex; gap:20px; align-items:center;">
    <div>Punkty: <span id="points">0</span></div>
    <div>Czas gry: <span id="gameClock">00:00</span></div>
  </div>

  <div id="quizBox"></div>
  <div id="overlayMessage"></div>
</div>

<div id="screen-end" style="display:none;">
  <h2 id="endMessage"></h2>
</div>

<script>
const overlay = document.getElementById("overlayMessage");
const ROUTE = ["A","B","C","D","E"];
let routeIndex = 0;
let routeDirection = 1;
let currentTarget = null;
let history = [];
let points = 0;
let isLocked = false;
let timeLeft = 5;
let timerInterval = null;
let gameFinished = false;
let gameStartTime = null;
let gameClockInterval = null;

/* ELEMENTY */
const startBtn = document.getElementById("startBtn");
const targetInfo = document.getElementById("targetInfo");
const status = document.getElementById("status");
const timerInfo = document.getElementById("timerInfo");
const pointsEl = document.getElementById("points");

/* ðŸ”¹ START I KIERUNEK TRASY */
function initializeRoute() {
  routeIndex = Math.floor(Math.random() * ROUTE.length);
  routeDirection = Math.random() < 0.5 ? 1 : -1;
  currentTarget = ROUTE[routeIndex];
  history = [currentTarget];
  targetInfo.innerHTML = `Aktualny kod: <span class="green big">${currentTarget}</span>`;
  updateHistory();
}

/* ðŸ”¹ NASTÄ˜PNY PUNKT */
function moveToNextTarget() {
  routeIndex = (routeIndex + routeDirection + ROUTE.length) % ROUTE.length;
  currentTarget = ROUTE[routeIndex];
  history.push(currentTarget);
  targetInfo.innerHTML = `Aktualny kod: <span class="green big">${currentTarget}</span>`;
  updateHistory();
}

/* ðŸ”¹ TIMER 5 SEKUND */
function startTimer() {
  clearInterval(timerInterval);
  timeLeft = 5;
  timerInfo.innerText = `Czas: ${timeLeft}s`;

  timerInterval = setInterval(() => {
    timeLeft--;
    timerInfo.innerText = `Czas: ${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      lockGame();
    }
  }, 1000);
}

/* ðŸ”¹ BLOKADA */
function lockGame() {
  isLocked = true;
  document.body.classList.add("locked");
  overlay.style.display = "flex";
  overlay.innerText = "BLOKADA";
  if(navigator.vibrate) navigator.vibrate([200,100,200,100,400]);
}

/* ðŸ”¹ ODBLOKOWANIE */
function unlockGame() {
  if(!isLocked) return;
  isLocked = false;
  document.body.classList.remove("locked");
  overlay.style.display = "none";
  startTimer();
}

/* ðŸ”¹ OBSÅUGA SKANU */
function onScan(text) {
  if(gameFinished) return;

  let code = text.toUpperCase().trim();

  if(isLocked){
    if(code === "UNLOCK") unlockGame();
    return;
  }

  if(code === currentTarget){
    points++;
    pointsEl.innerText = points;
    flashScreen("success","SUKCES");

    if(points >= 5){
      gameFinished = true;
      clearInterval(timerInterval);
      clearInterval(gameClockInterval);
      overlay.style.display = "flex";
      overlay.innerText = `WYGRANA!\nCzas: ${document.getElementById("gameClock").innerText}`;
      return;
    }

    setTimeout(()=>{
      moveToNextTarget();
      startTimer();
    },400);

  } else {
    flashScreen("error","BÅÄ˜DNY KOD");
  }
}

/* ðŸ”¹ FLASH EFEKT */
function flashScreen(type,message){
  overlay.style.display = "flex";
  overlay.innerText = message;

  if(type === "success") document.body.classList.add("flash-success");
  if(type === "error") document.body.classList.add("flash-error");

  setTimeout(()=>{
    document.body.classList.remove("flash-success");
    document.body.classList.remove("flash-error");
    overlay.style.display = "none";
  },400);
}

/* ðŸ”¹ HISTORIA */
function updateHistory(){
  document.getElementById("historyInfo").innerText =
    "Historia: " + history.join(" â†’ ");
}

/* ðŸ”¹ ZEGAR GRY */
function startGameClock(){
  gameStartTime = Date.now();
  gameClockInterval = setInterval(()=>{
    const elapsed = Date.now() - gameStartTime;
    const seconds = Math.floor(elapsed/1000);
    const minutes = Math.floor(seconds/60);
    const displaySeconds = seconds % 60;
    document.getElementById("gameClock").innerText =
      String(minutes).padStart(2,"0")+":"+String(displaySeconds).padStart(2,"0");
  },200);
}

/* ðŸ”¹ START BUTTON */
startBtn.onclick = async () => {
  if('NDEFReader' in window){
    try{
      const nfcReader = new NDEFReader();
      await nfcReader.scan();
      nfcReader.onreading = event => {
        const decoder = new TextDecoder();
        const record = event.message.records[0];
        let text = decoder.decode(record.data).replace(/\u0000/g,"").trim().toUpperCase();
        onScan(text);
      };
    }catch(err){ console.log("BÅ‚Ä…d NFC:",err); }
  }

  document.getElementById("screen-init").style.display="none";
  document.getElementById("screen-game").style.display="block";

  startGameClock();
  initializeRoute();
  startTimer();
};
</script>
</body>
</html>
