<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Mini gra QR – quiz + skan</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #reader { width: 260px; margin-top: 10px; display:none; }
  button { padding: 10px 18px; font-size: 18px; margin: 5px; }
  .info { margin-top: 10px; font-weight: bold; font-size: 18px; }
  .big { font-size: 22px; }
  .green { color: green; }
  .red { color: red; }
  .blink { animation: blinker 0.7s linear infinite; }
  @keyframes blinker { 50% { opacity: 0; } }
</style>
</head>

<body>

<h1>Mini gra QR - 9.4.3</h1>

<div id="screen-init">
  <p>Zeskanowałeś kod startowy.</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <p class="info big" id="targetInfo"></p>
  <p class="info" id="status"></p>
  <p class="info" id="timerInfo"></p>
  <p class="info" id="historyInfo">Historia:</p>
  <p class="info">Punkty: <span id="points">0</span></p>

  <div id="quizBox"></div>
  <div id="reader"></div>
</div>

<div id="taskSelect" style="display:none;">
  <p class="info big">Wybierz zadanie:</p>
  <button onclick="selectTask('QUIZ')">QUIZ</button>
  <button onclick="selectTask('SCAN_ONLY')">SKAN</button>
  <button onclick="selectTask('MIX')">MIX</button>
  <button onclick="selectTask('TIME')">CZAS</button>
  <button onclick="selectTask('BLOCK')">BLOKADA</button>
</div>

<div id="screen-end" style="display:none;">
<h2 id="endMessage"></h2>
</div>

<script>
const CODES = ["A","B","C"];
let gameState = "INIT";
let currentTarget = null;
let previousTargets = [];
let points = 0;
let countdown = 5;
let countdownInterval;
let html5QrCode;
let currentTask = null;
let timeBonus = 0;
let scanBlocked = false;

/* ELEMENTY */
const targetInfo = document.getElementById("targetInfo");
const status = document.getElementById("status");
const timerInfo = document.getElementById("timerInfo");
const historyInfo = document.getElementById("historyInfo");
const pointsEl = document.getElementById("points");
const quizBox = document.getElementById("quizBox");
const reader = document.getElementById("reader");
const taskSelect = document.getElementById("taskSelect");

/* HISTORIA */
function updateHistory() {
  const visible = previousTargets.slice(0, -1);
  historyInfo.innerText = "Historia: " + visible.join(" → ");
}

/* LOSOWANIE */
function pickNextTarget() {
  const available = CODES.filter(c => c !== currentTarget);
  currentTarget = available[Math.floor(Math.random() * available.length)];
  previousTargets.push(currentTarget);
  targetInfo.innerHTML = `KOD DO ZESKANOWANIA: <span class="green big">${currentTarget}</span>`;
  updateHistory();
}

/* WYBÓR ZADANIA */
function showTaskSelect() {
  currentTask = null;
  timeBonus = 0;
  scanBlocked = false;
  taskSelect.style.display = "block";
  reader.style.display = "none";
  quizBox.innerHTML = "";
  status.innerText = "";
  timerInfo.innerText = "";
}

function selectTask(task) {
  currentTask = task;
  taskSelect.style.display = "none";

  if(task === "QUIZ") {
    status.innerText = "QUIZ";
    generateQuiz();
  }

  if(task === "TIME") {
    timeBonus = Math.random() < 0.5 ? 2 : -2;
    status.innerText = `CZAS: ${timeBonus > 0 ? "+" : ""}${timeBonus}s`;
    startScanPhase();
  }

  if(task === "BLOCK") {
    status.innerText = "BLOKADA SKANERA – 3 SEKUNDY";
    startScanPhase();
    activateScanBlock();
  }

  if(task === "MIX") {
    status.innerText = "UTRUDNIENIE MIX";
    startScanPhase();
  }

  if(task === "SCAN_ONLY") {
    status.innerText = "SKANUJ KOD";
    startScanPhase();
  }
}

/* QUIZ */
function generateQuiz() {
  quizBox.innerHTML = `<button onclick="startScanPhase()">OK</button>`;
}

/* SKAN */
function startScanPhase() {
  reader.style.display = "block";
  startCountdown();

  if(!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScan,
      ()=>{}
    );
  }
}

function onScan(text) {
  if(scanBlocked) return;

  const url = new URL(text, window.location.href);
  const code = url.searchParams.get("code");

  if(code === currentTarget) {
    clearInterval(countdownInterval);
    points++;
    pointsEl.innerText = points;
    resetTimeBonus();
    pickNextTarget();
    showTaskSelect();
  }
}

/* CZAS */
function startCountdown() {
  clearInterval(countdownInterval);
  countdown = 5 + timeBonus;
  timerInfo.innerText = `Czas: ${countdown}s`;

  countdownInterval = setInterval(() => {
    countdown--;
    timerInfo.innerText = `Czas: ${countdown}s`;
    if(countdown <= 0) {
      clearInterval(countdownInterval);
      resetTimeBonus();
      handleFail();
    }
  },1000);
}

function resetTimeBonus() {
  timeBonus = 0;
}

/* BLOKADA */
function activateScanBlock() {
  scanBlocked = true;
  setTimeout(() => {
    scanBlocked = false;
    status.innerText = "SKANER AKTYWNY";
  }, 3000);
}

/* COFANIE */
function handleFail() {
  previousTargets.pop();
  currentTarget = previousTargets[previousTargets.length - 1];
  points = Math.max(0, points - 1);
  pointsEl.innerText = points;
  targetInfo.innerHTML = `KOD DO ZESKANOWANIA: <span class="green big">${currentTarget}</span>`;
  startScanPhase();
}

/* START */
document.getElementById("startBtn").onclick = () => {
  document.getElementById("screen-init").style.display = "none";
  document.getElementById("screen-game").style.display = "block";
  pickNextTarget();
  showTaskSelect();
};
</script>

</body>
</html>
