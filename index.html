<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mini gra QR ‚Äì du≈ºa litera</title>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#f4f4f4;
}

h1 { font-size: 26px; margin:16px; text-align:center; }

button {
  width: 100%;
  padding: 18px;
  font-size: 22px;
  margin: 10px 0;
  border-radius: 12px;
  border: none;
  background: #007bff;
  color: white;
}

button:active { background: #0056b3; }

/* --- EKRAN GRY --- */
#screen-game {
  height: 100vh;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
}

/* üîπ Litera centralna */
#letterContainer {
  flex:5;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size: 12vw;
  font-weight:bold;
}

/* üîπ Timer */
#timerContainer {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size: 8vw;
  font-weight:bold;
}

/* üîπ Punkty i czas gry na dole */
#bottomInfo {
  flex:1;
  display:flex;
  justify-content:space-around;
  align-items:center;
  width:100%;
  font-size: 4vw;
}

/* üîπ Overlay efekty */
#overlayMessage {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:none;
  justify-content:center;
  align-items:center;
  font-size:8vw;
  font-weight:bold;
  z-index:999;
  text-align:center;
}

.flash-success { background-color: #00cc44 !important; color:black !important; }
.flash-error   { background-color: #ff4444 !important; color:black !important; }
.locked        { background-color: #cc0000 !important; color:black !important; }

</style>
</head>

<body>
<h1>Mini gra QR ‚Äì 9.6.9</h1>

<div id="screen-init">
  <p>Zeskanowa≈Çe≈õ kod startowy.</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <div id="letterContainer"><span id="targetInfo"></span></div>
  <div id="timerContainer"><span id="timerInfo"></span></div>
  <div id="bottomInfo">
    <div>Punkty: <span id="points">0</span></div>
    <div>Czas gry: <span id="gameClock">00:00</span></div>
  </div>
  <div id="overlayMessage"></div>
</div>

<div id="screen-end" style="display:none;">
  <h2 id="endMessage"></h2>
</div>

<script>
const overlay = document.getElementById("overlayMessage");
let history = [];
let points = 0;
let isLocked = false;
let timeLeft = 5;
let timerInterval = null;
let gameFinished = false;
let gameStartTime = null;
let gameClockInterval = null;

/* STA≈ÅA TRASA */
const ROUTE = ["A","B","C","D","E"];
let routeIndex = 0;
let routeDirection = 1;
let currentTarget = null;

/* ELEMENTY */
const startBtn = document.getElementById("startBtn");
const targetInfo = document.getElementById("targetInfo");
const timerInfo = document.getElementById("timerInfo");
const pointsEl = document.getElementById("points");

/* --- INICJALIZACJA TRASY --- */
function initializeRoute() {
  routeIndex = Math.floor(Math.random() * ROUTE.length);
  routeDirection = Math.random() < 0.5 ? 1 : -1;
  currentTarget = ROUTE[routeIndex];
  history = [currentTarget];
  targetInfo.innerText = currentTarget;
}

/* --- PRZEJ≈öCIE DO NASTƒòPNEGO PUNKTU --- */
function moveToNextTarget() {
  routeIndex = (routeIndex + routeDirection + ROUTE.length) % ROUTE.length;
  currentTarget = ROUTE[routeIndex];
  history.push(currentTarget);
  targetInfo.innerText = currentTarget;
}

/* --- TIMER 5s --- */
function startTimer() {
  clearInterval(timerInterval);
  timeLeft = 5;
  timerInfo.innerText = `${timeLeft}s`;

  timerInterval = setInterval(()=>{
    timeLeft--;
    timerInfo.innerText = `${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      lockGame();
    }
  },1000);
}

/* --- BLOKADA --- */
function lockGame() {
  isLocked = true;
  document.body.classList.add("locked");
  overlay.style.display = "flex";
  overlay.innerText = "BLOKADA";
  if(navigator.vibrate) navigator.vibrate([200,100,200,100,400]);
}

/* --- ODBLOKOWANIE --- */
function unlockGame(){
  if(!isLocked) return;
  isLocked=false;
  document.body.classList.remove("locked");
  overlay.style.display="none";
  startTimer();
}

/* --- SKAN --- */
function onScan(text){
  if(gameFinished) return;

  let code = text.toUpperCase().trim();

  if(isLocked){
    if(code === "UNLOCK") unlockGame();
    return;
  }

  if(code === currentTarget){
    history.push(currentTarget);
    points++;
    pointsEl.innerText = points;
    flashScreen("success","SUKCES");

    if(points >= 5){
      gameFinished=true;
      clearInterval(timerInterval);
      clearInterval(gameClockInterval);
      overlay.style.display="flex";
      overlay.style.backgroundColor="#00cc44";
      overlay.innerHTML=`WYGRANA!<br>Czas: ${document.getElementById("gameClock").innerText}<br>Trasa: ${history.join(" ‚Üí ")}`;
      return;
    }

    setTimeout(()=>{
      moveToNextTarget();
      startTimer();
    },400);

  } else {
    flashScreen("error","B≈ÅƒòDNY KOD");
  }
}

/* --- FLASH EFEKTY --- */
function flashScreen(type,message){
  overlay.style.display="flex";
  overlay.innerText=message;

  if(type==="success") document.body.classList.add("flash-success");
  if(type==="error") document.body.classList.add("flash-error");

  setTimeout(()=>{
    document.body.classList.remove("flash-success");
    document.body.classList.remove("flash-error");
    overlay.style.display="none";
  },400);
}

/* --- ZEGAR GRY --- */
function startGameClock(){
  gameStartTime=Date.now();
  gameClockInterval=setInterval(()=>{
    const elapsed=Date.now()-gameStartTime;
    const seconds=Math.floor(elapsed/1000);
    const minutes=Math.floor(seconds/60);
    const displaySeconds=seconds%60;
    document.getElementById("gameClock").innerText=
      String(minutes).padStart(2,"0")+":"+String(displaySeconds).padStart(2,"0");
  },200);
}

/* --- START --- */
startBtn.onclick=async()=>{
  if('NDEFReader' in window){
    try{
      const nfcReader=new NDEFReader();
      await nfcReader.scan();
      nfcReader.onreading=event=>{
        const decoder=new TextDecoder();
        const record=event.message.records[0];
        let text=decoder.decode(record.data).replace(/\u0000/g,"").trim().toUpperCase();
        onScan(text);
      };
    }catch(e){console.log("B≈ÇƒÖd NFC:",e);}
  }

  document.getElementById("screen-init").style.display="none";
  document.getElementById("screen-game").style.display="flex";

  startGameClock();
  initializeRoute();
  startTimer();
};
</script>
</body>
</html>
