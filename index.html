<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Mini gra QR ‚Äì quiz + skan</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #reader { width: 260px; margin-top: 10px; display:none; }
  button { padding: 10px 18px; font-size: 18px; margin: 5px; }
  .info { margin-top: 10px; font-weight: bold; font-size: 18px; }
  .big { font-size: 22px; }
  
  .next-code {
  font-size: 32px;
  color: green;
  font-weight: bold;
  
  .scan-code {
  font-size: 28px;
  font-weight: bold;
}

.green {
  color: green;
}

.red {
  color: red;
}

.blink {
  animation: blinkAnim 1s infinite;
}

@keyframes blinkAnim {
  0% { opacity: 1; }
  50% { opacity: 0; }
  100% { opacity: 1; }
}
}
</style>

</head>

<body>

<h1>Mini gra QR - 9.3.8</h1>

<div id="screen-init">
  <p>Zeskanowa≈Çe≈õ kod startowy.</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <p class="info big" id="targetInfo"></p>
  <p class="info" id="status"></p>
  <p class="info" id="timerInfo"></p>
  <p class="info" id="historyInfo">Historia:</p>
  <p class="info">Punkty: <span id="points">0</span></p>

  <div id="quizBox"></div>
  
  <div id="reader"></div>
</div>

<div id="taskSelect" style="display:none;">
  <p class="info big">Wybierz zadanie:</p>
  <button onclick="selectTask('QUIZ')">QUIZ</button>
  <button onclick="selectTask('SCAN_ONLY')">TYLKO SKAN</button>
  <button onclick="selectTask('MIX')">UTRUDNIENIE ‚Äì MIX</button>
</div>

<div id="screen-end" style="display:none;">
<h2 id="endMessage"></h2>
</div>

<script>
/* ===================== PODSTAWY ===================== */

const CODES = ["A","B","C"];
let gameState = "INIT"; // INIT | TASK_SELECT | QUIZ | SCAN | FINISHED

let currentTarget = null;
let previousTargets = [];
let points = 0;

let countdown = 5;
let countdownInterval;
let html5QrCode;

let phase = "QUIZ";

/* ===================== ELEMENTY ===================== */

const startBtn = document.getElementById("startBtn");
const targetInfo = document.getElementById("targetInfo");
const status = document.getElementById("status");
const timerInfo = document.getElementById("timerInfo");
const historyInfo = document.getElementById("historyInfo");
const pointsEl = document.getElementById("points");
const quizBox = document.getElementById("quizBox");
const reader = document.getElementById("reader");
const taskSelect = document.getElementById("taskSelect");


  
/* ===================== HISTORIA ===================== */

function updateHistory() {
  const visibleHistory = previousTargets.slice(0, -1);
  historyInfo.innerText = "Historia: " + visibleHistory.join(" ‚Üí ");
}

/* ===================== LOSOWANIE KODU ===================== */

function pickNextTarget() {
  const available = CODES.filter(c => c !== currentTarget);
  currentTarget = available[Math.floor(Math.random() * available.length)];
  previousTargets.push(currentTarget);

  //targetInfo.innerText = `Nastƒôpny kod: ${currentTarget}`;
  targetInfo.innerHTML = `Nastƒôpny kod: <span class="next-code">${currentTarget}</span>`;
  updateHistory();
}

/* ===================== WYB√ìR ZADANIA ===================== */

let currentTask = null;

function showTaskSelect() {
  gameState = "TASK_SELECT";
  quizBox.innerHTML = "";
  reader.style.display = "none";
  taskSelect.style.display = "block";
  status.innerText = "";
  timerInfo.innerText = "";
}

function selectTask(task) {
  currentTask = task;
  taskSelect.style.display = "none";

  if(task === "QUIZ") {
    status.innerText = "QUIZ";
    generateQuiz();
  } 
  else if(task === "MIX") {
    status.innerText = "Utrudnienie MIX";
    startScanPhase();
  }
  else {
    status.innerText = "SKANUJ KOD QR.";
    startScanPhase();
  }
}

/* ================== UTRUDNIENIE MIX ‚Äì ROTACJA KOD√ìW ================== */

function resolveExpectedCode(task, target) {
  if(task !== "MIX") return target;

const index = CODES.indexOf(target);
const nextIndex = (index + 1) % CODES.length;
return CODES[nextIndex];
}
  
/* ===================== QUIZ ===================== */

function generateQuiz() {
  gameState = "QUIZ";
  reader.style.display = "none";
  quizBox.innerHTML = "";
  timerInfo.innerText = "";

  const a = rand();
  const b = rand();
  const c = rand();
  const d = rand();

  const op1 = randOp();
  const op2 = randOp();

  const left = evalSafe(a, op1, b);
  const right = evalSafe(c, op2, d);

  const correct = left > right ? ">" : "<";

  quizBox.innerHTML = `
    <p class="big">${a} ${op1} ${b} ? ${c} ${op2} ${d}</p>
    <button onclick="quizAnswer('>','${correct}')">&gt;</button>
    <button onclick="quizAnswer('<','${correct}')">&lt;</button>
  `;
}

function quizAnswer(answer, correct) {
  if(answer === correct) {
    status.innerText = "Dobrze! Skanuj kod.";
    startScanPhase();
  } else {
    status.innerText = "B≈ÇƒÖd w quizie ‚Äì cofanie";
    handleFail();
  }
}

/* ===================== SKAN ===================== */

function startScanPhase() {
  gameState = "SCAN";
  quizBox.innerHTML = "";
  reader.style.display = "block";
  startCountdown();

  if(!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScan,
      ()=>{}
    );
  }
}

function onScan(text) {
  if(gameState !== "SCAN") return;

  const url = new URL(text, window.location.href);
  const code = url.searchParams.get("code");

  const expectedCode = resolveExpectedCode(currentTask, currentTarget);

if(code === expectedCode) {

  // ‚úÖ ZAMKNIƒòCIE ETAPU MIX
  const wasMix = currentTask === "MIX";
  currentTask = null;

  clearInterval(countdownInterval);
  points++;
  pointsEl.innerText = points;

  status.className = "";   // zerowanie wszystkich klas
  status.innerText = "DOBRZE!";

  if(points >= 5) {
    endGame("Wygrana! 5 punkt√≥w");
  } else {
    pickNextTarget();
    showTaskSelect();
  }
} else if(currentTask === "MIX") {

  // üîí zamykamy lokalny etap MIX
  currentTask = null;

  //status.innerText = "Z≈Çy kod! Wracasz do poprzedniego skanu";
  //handleFail(true);
  status.innerText = "Z≈Çy kod! Wracasz do poprzedniego skanu";
  status.className = "red";
  handleFail(true);

} else {
  //status.innerText = "Niepoprawny kod ‚Äì spr√≥buj jeszcze raz";
  status.innerText = "Niepoprawny kod ‚Äì spr√≥buj jeszcze raz";
  status.className = "red";
}
}
/* ===================== CZAS ===================== */

function startCountdown() {
  clearInterval(countdownInterval);
  countdown = 5;
  timerInfo.innerText = `Czas: ${countdown}s`;

  countdownInterval = setInterval(() => {
    countdown--;
    timerInfo.innerText = `Czas: ${countdown}s`;
    if(countdown <= 0) {
  clearInterval(countdownInterval);

  if (currentTask === "MIX") {
    currentTask = null; // ZAMKNIƒòCIE MIX PRZY TIMEOUT
  }

  handleFail();
}
  },1000);
}

/* ===================== COFANIE ===================== */

function handleFail() {
  clearInterval(countdownInterval);

  if(previousTargets.length <= 1) {
    endGame("Pora≈ºka ‚Äì brak punkt√≥w");
    return;
  }

  // cofamy historiƒô
  previousTargets.pop();
  currentTarget = previousTargets[previousTargets.length - 1];

  // odejmujemy punkt
  if(points > 0) points--;
  pointsEl.innerText = points;

  updateHistory();
  targetInfo.innerText = `Powt√≥rz kod: ${currentTarget}`;
  //status.innerText = "Cofniƒôcie ‚Äì zeskanuj ponownie";
  status.innerHTML = `Cofniƒôcie !!! SKANUJ &gt; <span class="scan-code">${currentTarget}</span> &lt;`;
  status.className = "blink green";

  // ‚ùó KLUCZOWA ZMIANA
  startScanPhase();   // ‚úÖ ZAWSZE WRACAMY DO SKANU
}

/* ===================== KONIEC ===================== */

function endGame(msg) {
  gameState = "FINISHED";
  document.getElementById("screen-game").style.display = "none";
  document.getElementById("screen-end").style.display = "block";
  //document.getElementById("endMessage").innerText = msg;
  document.getElementById("endMessage").innerHTML = `<span class="red">${msg}</span>`;
  if(html5QrCode) html5QrCode.stop();
  clearInterval(countdownInterval);
}

/* ===================== START ===================== */

startBtn.onclick = () => {
  document.getElementById("screen-init").style.display = "none";
  document.getElementById("screen-game").style.display = "block";
  pickNextTarget();
  showTaskSelect();
};

/* ===================== NARZƒòDZIA ===================== */

function rand() { return Math.floor(Math.random()*9)+1; }
function randOp() { return ["+","-","*","/"][Math.floor(Math.random()*4)]; }
function evalSafe(a,op,b) {
  if(op==="/") return a/b;
  if(op==="*") return a*b;
  if(op==="+") return a+b;
  return a-b;
}
</script>

</body>
</html>






